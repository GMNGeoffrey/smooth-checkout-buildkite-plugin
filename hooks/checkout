#!/usr/bin/env bash

set -eo pipefail

if [[ "$BUILDKITE_PLUGIN_SMOOTH_CHECKOUT_SKIP_CHECKOUT" == "true" ]]; then
    echo "--- :fast_forward: Skipping checkout"
    echo "Because 'skip_checkout' configuration was set as true in pipeline YAML"
    exit 0
fi

echo "--- :open_file_folder: Setting up workspace"
WORKSPACE="$HOME/buildkite-checkouts/$BUILDKITE_BUILD_ID/$BUILDKITE_JOB_ID"
echo "Creating directory: $WORKSPACE"
mkdir -p "$WORKSPACE" && cd "$WORKSPACE"
echo "Setup completed successfully."


echo "--- :key: Setting up git and ssh"
mkdir -p "$HOME/.ssh" && ssh-keyscan -t rsa github.com >> "$HOME/.ssh/known_hosts"

echo "--- :git: Checking out repository"
CLONE_URL=${BUILDKITE_PLUGIN_SMOOTH_CHECKOUT_CLONE_URL:-$BUILDKITE_REPO}
CLONE_DIR=$(echo "${CLONE_URL%/}" | awk -F '/' '{ print $NF }' | sed -e "s/\.git$//")

echo "Cloning repository: $CLONE_URL at $(pwd)/$CLONE_DIR"
git clone --no-checkout "$CLONE_URL" && cd "$CLONE_DIR"

REF=${BUILDKITE_PLUGIN_SMOOTH_CHECKOUT_REF:-$BUILDKITE_BRANCH}
echo "Checking out ref: $REF"
git fetch --force origin "$REF:refs/local/$REF"
git checkout --quiet --force "refs/local/$REF"
git log -n 1 --format="Repo checked out at %h %s"

